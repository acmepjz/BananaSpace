function internalLinkClick(){var n=$.attr(this,"href");return n!="#"&&$root.animate({scrollTop:$(n).offset().top},500),!1}var fileId=0,onConfirm=!1,$root;$(function(){var r,n,t,f,u;$(".dialog").each(function(){$(this).dialog({appendTo:".container",autoOpen:!1,closeText:"关闭",modal:!0,resizable:!1,width:400})});$("form").submit(function(){$(".button-submit").attr("disabled","disabled")});$("#_btn-fav").click(function(){var n=$(this);if(!n.attr("disabled")){n.attr("disabled","disabled");var r=n.attr("data-page-id"),i=new FormData,t=n.attr("data-action"),u=$('input[name="__RequestVerificationToken"]').val();i.append("Action",t);$.ajax({url:"/page/"+r,data:i,processData:!1,contentType:!1,headers:{RequestVerificationToken:u},type:"POST",success:function(){n.removeAttr("disabled").attr("data-action",t=="add-fav"?"cancel-fav":"add-fav").text(t=="add-fav"?"取消收藏":"收藏文档")}})}});$(".creator-email").tooltip({items:".creator-email",content:function(){return'创建者邮箱: <code class="noselect">'+$("<div/>").text($(this).attr("data-email")).html().replace("@",'<span class="span-at"><\/span>')+"<\/code>"}});$("#dialog-add-page").on("dialogopen",function(){$("#dialog-section-number-textbox").val("");$("#dialog-title-textbox").val("")});if(r=$(".textarea-code"),r.length>0&&CodeMirror){n=CodeMirror.fromTextArea(r[0],{lineNumbers:!0,lineWrapping:!0,mode:"tex",readOnly:r.attr("readonly")?!0:!1});n.init(n);n.on("change",function(){var t=n.historySize();t.undo>0?($("#_btn-undo").removeClass("no-display"),$("#_btn-undo-disabled").addClass("no-display")):($("#_btn-undo").addClass("no-display"),$("#_btn-undo-disabled").removeClass("no-display"));t.redo>0?($("#_btn-redo").removeClass("no-display"),$("#_btn-redo-disabled").addClass("no-display")):($("#_btn-redo").addClass("no-display"),$("#_btn-redo-disabled").removeClass("no-display"))});$("#_btn-undo").click(function(){n.undo();n.focus()});$("#_btn-redo").click(function(){n.redo();n.focus()});function i(n){return n.anchor.line>n.head.line||n.anchor.line==n.head.line&&n.anchor.ch>n.head.ch?-1:n.anchor.line==n.head.line&&n.anchor.ch==n.head.ch?0:1}$("#_btn-comment").click(function(){var r=n.listSelections(),t;r.length==1&&(t=r[0],i(t)==-1?n.lineComment(t.head,t.anchor):n.lineComment(t.anchor,t.head));n.focus()});$("#_btn-uncomment").click(function(){var r=n.listSelections(),t;r.length==1&&(t=r[0],i(t)==-1?n.uncomment(t.head,t.anchor):n.uncomment(t.anchor,t.head));n.focus()});$("#_btn-add-braces").click(function(){for(var u=n.listSelections(),r=u.length,f,t,e;r--;)t=u[r],i(t)==-1?(n.replaceRange("}",t.anchor,null,"+move"),n.replaceRange("{",t.head,null,"+move")):(n.replaceRange("}",t.head,null,"+move"),n.replaceRange("{",t.anchor,null,"+move"));for(u=n.listSelections(),f=[],r=0;r<u.length;r++)t=u[r],e=i(t),e==-1?f.push({anchor:{line:t.anchor.line,ch:t.anchor.ch-1},head:t.head}):e==0?f.push({anchor:{line:t.anchor.line,ch:t.anchor.ch-1},head:{line:t.head.line,ch:t.head.ch-1}}):e==1&&f.push({anchor:t.anchor,head:{line:t.head.line,ch:t.head.ch-1}});n.setSelections(f);n.focus()});$("#_btn-add-env").click(function(){for(var f=n.listSelections(),r=f.length,o,t,s,e,h,u;r--;)t=f[r],i(t)==-1?(n.replaceRange("\r\n\\end{}",t.anchor,null,"+move"),n.replaceRange("\\begin{}\r\n",t.head,null,"+move")):(n.replaceRange("\r\n\\end{}",t.head,null,"+move"),n.replaceRange("\\begin{}\r\n",t.anchor,null,"+move"));for(f=n.listSelections(),o=[],r=0;r<f.length;r++)t=f[r],s=i(t),s==-1?(e=t.head.line-1,h=t.anchor.line):s==0?(e=t.anchor.line-2,h=t.anchor.line):s==1&&(e=t.anchor.line-1,h=t.head.line),u={line:e,ch:n.getLine(e).length-1},o.push({anchor:u,head:u}),u={line:h,ch:5},o.push({anchor:u,head:u});n.setSelections(o);n.focus()})}if(typeof CodeMirror!="undefined"&&CodeMirror.colorize&&CodeMirror.colorize($(".code-snippet"),"tex"),$(".editor-container").length>0){$(".editor-tab-link").click(function(){if($(this).parents(".editor-tab-link-inactive").length!==0){var n=$(".editor-tab-active").removeClass("editor-tab-active"),t=$(".editor-tab-inactive").removeClass("editor-tab-inactive"),i=$(".editor-tab-link-active").removeClass("editor-tab-link-active"),r=$(".editor-tab-link-inactive").removeClass("editor-tab-link-inactive");n.addClass("editor-tab-inactive");t.addClass("editor-tab-active");i.addClass("editor-tab-link-inactive");r.addClass("editor-tab-link-active")}});$(document).keydown(function(n){for(var t=undefined,i=[n.key,n.keyIdentifier,n.keyCode,n.which];t===undefined&&i.length>0;)t=i.pop();return t&&(t==115||t==83)&&(n.ctrlKey||n.metaKey)&&!n.altKey?(n.preventDefault(),$(".editor-save-button").trigger("click"),!1):!0});var e=$(".editor-container form"),u=e.attr("data-page-id"),f=$('input[name="__RequestVerificationToken"]').val();$(".editor-save-button").click(function(){var n=$(this),t;n.attr("disabled")||(n.attr("disabled","disabled").text("正在保存..."),o(),t=new FormData(e[0]),t.append("Action","save"),$.ajax({url:"/page/"+u+"/edit",data:t,processData:!1,contentType:!1,headers:{RequestVerificationToken:f},type:"POST",complete:function(){n.removeAttr("disabled").text("保存并预览")},success:function(n){$(".previewer-container .box").html(n);$('a[href^="#"]').click(internalLinkClick);MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub]);CodeMirror.colorize&&CodeMirror.colorize($(".code-snippet"),"tex");window.onbeforeunload=null},error:function(){alert("保存失败。")}}))});$(".editor-publish-button").click(function(){var n=$(this);n.attr("disabled")||(n.attr("disabled","disabled"),$(".editor-save-button").attr("disabled","disabled"),o(),e.append($('<input name="Action" type="hidden" value="publish">')).submit())});function o(){n!==undefined&&r.text(n.getValue())}}if(t=$("#_file-input"),t.length>0){fileId=1e3;f=$('input[name="__RequestVerificationToken"]').val();u=t.attr("data-page-id");$(".file-upload-link").click(function(){$("#_file-input").trigger("click")});$(".file-delete-link").click(s);t.change(function(){var u,f;if(t.val()!=""){var e=fileId++,n=t[0].files[0],i=!1,r=!1;if(t.val(""),/\.(jpg|jpeg|png|svg)$/i.test(n.name)?n.size>=2097152?i="文件大小不能超过 2 MB。":(u=!1,$(".file-list-item").each(function(){var t=$(this).find(".file-list-item-name").text();t.localeCompare(n.name,"en",{sensitivity:"base"})==0&&(u=$(this).attr("data-id"))}),u&&(r="上传此文件会替换原有的文件。确认上传吗？")):i="只能上传 JPEG, PNG 或 SVG 图片。",i||r){f=$(".dialog-confirm");f.find(".dialog-content").text(i||r);onConfirm=r?function(){h(e,n,u)}:!1;$(".ui-dialog-title").text("上传文件");f.addClass("dialog-open").dialog("open");return}h(e,n)}});function s(){var t=$(this).parents(".file-list-item").attr("data-id"),n=$(".dialog-confirm");n.find(".dialog-content").text("确认删除此文件吗？删除后将无法恢复，只能重新上传。");onConfirm=function(){c(t)};$(".ui-dialog-title").text("确认删除");n.addClass("dialog-open").dialog("open")}function h(n,t,i){i!==undefined&&$(".file-list-item[data-id="+i+"]").remove();$("<div>",{"class":"file-list-item list-item","data-id":n,html:$("<div>",{"class":"file-list-item-name",title:t.name}).text(t.name).add($("<div>",{"class":"file-progress-container",html:$("<div>",{"class":"file-progress",html:$("<div>",{"class":"file-progress-inner"})})})).add($("<div>",{html:$("<a>",{"class":"file-delete-link link-no-underline",href:"#"}).text("删除").click(s).css("display","none")}))}).appendTo(".file-list");var r=new FormData;r.append("PageId",u);r.append("Action","upload");r.append("File",t);$.ajax({url:"/UploadFile",data:r,headers:{RequestVerificationToken:f},processData:!1,contentType:!1,type:"POST",xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",function(t){if(t.lengthComputable){var i=t.loaded/t.total*100;$(".file-list-item[data-id="+n+"] .file-progress-inner").css("width",i+"%")}},!1),t},success:function(){$(".file-list-item[data-id="+n+"] .file-progress-container").html("上传成功");$(".file-list-item[data-id="+n+"] .file-delete-link").css("display","")},error:function(){$(".file-list-item[data-id="+n+"] .file-progress-container").html("上传失败")}})}function c(n){var i=$(".file-list-item[data-id="+n+"] .file-list-item-name").text(),t=new FormData;t.append("PageId",u);t.append("Action","delete");t.append("FileName",i);$(".file-list-item[data-id="+n+"] .file-progress-container").html("正在删除");$(".file-list-item[data-id="+n+"] .file-delete-link").css("display","none");$.ajax({url:"/UploadFile",data:t,headers:{RequestVerificationToken:f},processData:!1,contentType:!1,type:"POST",success:function(){$(".file-list-item[data-id="+n+"]").remove()},failed:function(){$(".file-list-item[data-id="+n+"] .file-progress-container").html("删除失败")}})}}});$(".list-item-unsel").click(function(){$(".list-item-sel").each(function(){$(this).removeClass("list-item-sel").addClass("list-item-unsel")});$(this).removeClass("list-item-unsel").addClass("list-item-sel")});$(".dialog-button").click(function(){$(".dialog-open").each(function(){$(this).removeClass("dialog-open").dialog("close")})});$(".dialog-button-confirm").click(function(){onConfirm&&onConfirm();onConfirm=!1});$(".link-confirm").click(function(){$(".dialog-confirm").addClass("dialog-open").dialog("open");var n=$(this),t=$(".dialog-confirm").parents(".ui-dialog");t.find("input[name=Action]").val(n.attr("data-action"));t.find("input[name=PageId]").val(n.attr("data-page-id"));t.find(".ui-dialog-title").text(n.attr("data-title"));t.find(".dialog-content").text(n.attr("data-message"))});$(".link-add-page").click(function(){$(".dialog-add-page").addClass("dialog-open").dialog("open");var n=$(this),t=$(".dialog-add-page").parents(".ui-dialog");t.find("input[name=Action]").val(n.attr("data-action"));t.find("input[name=PageId]").val(n.attr("data-page-id"))});$(".link-delete").click(function(){$(".dialog-delete").addClass("dialog-open").dialog("open");var n=$(this),t=$(".dialog-delete").parents(".ui-dialog");t.find("input[name=Action]").val(n.attr("data-action"));t.find("input[name=PageId]").val(n.attr("data-page-id"));t.find(".ui-dialog-title").text(n.attr("data-title"));t.find(".dialog-content").text(n.attr("data-message"))});$(".leave-no-confirm").click(function(){window.onbeforeunload=null});$root=$("html, body");$('a[href^="#"]').click(internalLinkClick);